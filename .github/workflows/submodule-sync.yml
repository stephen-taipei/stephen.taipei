name: Sync Submodules

# 觸發方式：
# 1. 定時檢查（每小時）- 主要同步機制
# 2. 手動觸發
on:
  schedule:
    - cron: '0 * * * *'  # 每小時檢查一次
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes'
        required: false
        default: false
        type: boolean

# 使用 GITHUB_TOKEN 而非 PAT
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: "20"

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      updated_modules: ${{ steps.check.outputs.updated_modules }}
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4.2.2
        with:
          submodules: recursive
          fetch-depth: 0
          # 使用預設的 GITHUB_TOKEN（公開 repo 不需要額外 token）

      - name: Check for submodule updates
        id: check
        run: |
          echo "Checking for submodule updates..."

          UPDATED_MODULES=""
          HAS_UPDATES="false"

          # Fetch latest from all submodules
          git submodule foreach --quiet 'git fetch origin'

          # Check each submodule for updates
          while IFS= read -r line; do
            if [ -z "$line" ]; then continue; fi

            # Parse submodule path
            path=$(echo "$line" | awk '{print $2}')

            # Get current and latest commit
            cd "$path"
            current=$(git rev-parse HEAD)

            # Get default branch
            default_branch=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
            latest=$(git rev-parse "origin/$default_branch" 2>/dev/null || git rev-parse origin/main 2>/dev/null || git rev-parse origin/master)

            if [ "$current" != "$latest" ]; then
              echo "  $path: $current -> $latest"
              UPDATED_MODULES="$UPDATED_MODULES $path"
              HAS_UPDATES="true"
            fi
            cd - > /dev/null
          done < <(git submodule status)

          # Handle force deploy
          if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            HAS_UPDATES="true"
            UPDATED_MODULES="force deploy"
          fi

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
          echo "updated_modules=$UPDATED_MODULES" >> $GITHUB_OUTPUT

          if [ "$HAS_UPDATES" = "true" ]; then
            echo "Updates found: $UPDATED_MODULES"
          else
            echo "No updates found"
          fi

  build-and-deploy:
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'
    uses: ./.github/workflows/deploy-prod.yml
    secrets: inherit
